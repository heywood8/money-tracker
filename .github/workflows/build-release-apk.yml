name: Build Android APK (EAS)

on:
  workflow_dispatch:
  push:
    tags:
      - 'penny-v*'

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v6

      - name: ðŸ— Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ðŸ— Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“¦ Install dependencies
        run: bun install

      - name: ðŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ” Setup credentials.json for signing
        run: |
          mkdir -p android/app
          echo "${{ secrets.MYAPP_UPLOAD_STORE_BASE64 }}" | base64 --decode > android/app/keystore.jks
          cat > credentials.json << EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "android/app/keystore.jks",
                "keystorePassword": "${{ secrets.MYAPP_UPLOAD_STORE_PASSWORD }}",
                "keyAlias": "${{ secrets.MYAPP_UPLOAD_KEY_ALIAS }}",
                "keyPassword": "${{ secrets.MYAPP_UPLOAD_KEY_PASSWORD }}"
              }
            }
          }
          EOF

      - name: ðŸš€ Build APK with EAS
        env:
          NODE_OPTIONS: --max_old_space_size=2048
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          eas build --platform android --local --profile preview --non-interactive

      - name: ðŸ“¦ Find and rename APK
        id: find_apk
        run: |
          # EAS build outputs APK in current directory or android/app/build/outputs/apk
          APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | grep -v "node_modules" | grep -v unaligned | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: No APK file found!"
            exit 1
          fi
          echo "Found APK: $APK_PATH"
          ls -lh "$APK_PATH"

          # Use git tag for filename
          TAG_NAME="${{ github.ref_name }}"
          NEW_NAME="${TAG_NAME}.apk"
          cp "$APK_PATH" "$NEW_NAME"
          echo "apk_path=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "Renamed to: $NEW_NAME"
          ls -lh "$NEW_NAME"

      - name: ðŸ“¤ Upload APK to Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_apk.outputs.apk_path }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Post build summary
        if: github.ref_type == 'tag'
        run: |
          echo "## ðŸš€ Android Build Completed (EAS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** preview" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK:** ${{ steps.find_apk.outputs.apk_path }}" >> $GITHUB_STEP_SUMMARY
