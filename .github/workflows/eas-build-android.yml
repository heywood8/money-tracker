name: EAS Build Android

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

jobs:
  build:
    name: EAS Build Android
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v6

      - name: ðŸ— Setup Node
        uses: oven-sh/setup-bun@v2
        with:
          node-version: '20.x'

      - name: ðŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¦ Install dependencies
        run: bun install

      - name: ðŸš€ Build tag
        if: github.ref_type == 'tag'
        env:
          NODE_OPTIONS: --max_old_space_size=4096
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          PROFILE="${{ github.event.inputs.profile || 'preview' }}"
          echo "Building with profile: $PROFILE"
          eas build --platform android --profile $PROFILE --non-interactive --no-wait 2>&1 | tee eas-build-output.txt
          
          # Extract the build URL from EAS output
          BUILD_URL=$(grep -oE 'https://expo\.dev/accounts/[^[:space:]]+/builds/[a-f0-9-]+' eas-build-output.txt | head -1)
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_ENV

      - name: ðŸš€ Build main
        if: github.ref_type == 'branch' && github.ref == 'refs/heads/main'
        run: |
          eas update --platform android --non-interactive --auto 2>&1 | tee eas-build-output.txt
          
          # Extract the build URL from EAS output
          BUILD_URL=$(grep -oE 'https://expo\.dev/accounts/[^[:space:]]+/builds/[a-f0-9-]+' eas-build-output.txt | head -1)
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_ENV

      - name: Post build URL to summary
        run: |
          echo "## ðŸš€ EAS Build Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Profile:** ${{ github.event.inputs.profile || 'preview' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build URL:** [$BUILD_URL]($BUILD_URL)" >> $GITHUB_STEP_SUMMARY
