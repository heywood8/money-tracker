name: Emulator Screenshots

on:
  pull_request:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: screenshots-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  screenshots:
    name: Capture App Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Expo prebuild (generate android project)
        env:
          APP_VARIANT: production
        run: bunx expo prebuild --platform android --clean

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      - name: Run emulator and capture screenshots
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_7_pro
          force-avd-creation: false
          ram-size: 2048
          heap-size: 512
          disk-size: 4096M
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -cores 2 -memory 2048
          disable-animations: true
          emulator-boot-timeout: 300
          script: |
            # Build release APK for x86_64 only (matches emulator arch, skips unnecessary ABIs)
            APP_VARIANT=production ./android/gradlew -p android assembleRelease -PreactNativeArchitectures=x86_64

            # Install the APK
            adb install android/app/build/outputs/apk/release/app-release.apk

            # Launch the app
            adb shell am start -n com.heywood8.monkeep/.MainActivity

            # Create output directory
            mkdir -p screenshots

            # Run Maestro flow to navigate and take screenshots
            maestro test .maestro/take-screenshots.yaml || true

            # Capture Maestro debug artifacts on failure
            cp -r ~/.maestro/tests/* screenshots/ 2>/dev/null || true

            # List captured screenshots
            ls -la screenshots/ || echo "No screenshots directory found"

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: app-screenshots
          path: screenshots/
          retention-days: 30
          if-no-files-found: warn

      - name: Push screenshots to ci-screenshots branch
        if: github.event_name == 'pull_request' && always()
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCREENSHOT_DIR="pr-${PR_NUMBER}"
          BACKUP_DIR="/tmp/screenshots-backup"

          # Check if any screenshots exist
          if ! ls screenshots/*.png 1>/dev/null 2>&1; then
            echo "No screenshot files found, skipping upload"
            exit 0
          fi

          # Save screenshots outside the working tree (branch switches may clean it)
          mkdir -p "$BACKUP_DIR"
          cp screenshots/*.png "$BACKUP_DIR/"

          # Configure git for the push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or switch to the ci-screenshots orphan branch
          git fetch origin ci-screenshots 2>/dev/null || true
          if git rev-parse --verify origin/ci-screenshots >/dev/null 2>&1; then
            git checkout ci-screenshots
          else
            git checkout --orphan ci-screenshots
            git rm -rf . 2>/dev/null || true
            git clean -fd 2>/dev/null || true
            git commit --allow-empty -m "Initialize ci-screenshots branch"
          fi

          # Copy screenshots into a PR-specific directory
          mkdir -p "${SCREENSHOT_DIR}"
          cp "$BACKUP_DIR"/*.png "${SCREENSHOT_DIR}/"

          # Commit and push
          git add "${SCREENSHOT_DIR}"
          git commit -m "Update screenshots for PR #${PR_NUMBER}" || echo "No changes to commit"
          git push origin ci-screenshots

          # Switch back to the PR branch and restore screenshots
          git checkout - 2>/dev/null || true
          mkdir -p screenshots
          cp "$BACKUP_DIR"/*.png screenshots/

      - name: Build PR comment body
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        id: set-screenshot-results
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const rawBase = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/ci-screenshots/pr-${prNumber}`;

            // Welcome screen (no light/dark variants)
            const welcomeScreen = { file: '00_language_selection', desc: 'Welcome / Language Selection' };

            // Screens with light/dark variants
            const themedScreens = [
              { file: '01_operations', desc: 'Operations' },
              { file: '05_transfer', desc: 'Multi-Currency Transfer' },
              { file: '02_graphs', desc: 'Graphs' },
              { file: '03_accounts', desc: 'Accounts' },
              { file: '04_categories', desc: 'Categories' },
            ];

            const lines = [
              '## App Screenshots',
              '',
            ];

            // Check if welcome screen exists
            const hasWelcome = fs.existsSync(`screenshots/${welcomeScreen.file}.png`);

            // Check which themed screenshots exist
            const availableThemed = themedScreens.filter(s =>
              fs.existsSync(`screenshots/${s.file}_light.png`) || fs.existsSync(`screenshots/${s.file}_dark.png`)
            );

            if (hasWelcome || availableThemed.length > 0) {
              // Welcome screen section (single image, no light/dark)
              if (hasWelcome) {
                const welcomeUrl = `${rawBase}/${welcomeScreen.file}.png`;
                lines.push(
                  '### Welcome Screen',
                  '',
                  `<img src="${welcomeUrl}" width="270" />`,
                  '',
                );
              }

              // Themed screens in a 3-column table
              if (availableThemed.length > 0) {
                lines.push(
                  '### App Screens',
                  '',
                  '| Screen | Light | Dark |',
                  '|--------|-------|------|',
                );
                for (const s of availableThemed) {
                  const lightUrl = `${rawBase}/${s.file}_light.png`;
                  const darkUrl = `${rawBase}/${s.file}_dark.png`;
                  const hasLight = fs.existsSync(`screenshots/${s.file}_light.png`);
                  const hasDark = fs.existsSync(`screenshots/${s.file}_dark.png`);
                  const lightImg = hasLight ? `<img src="${lightUrl}" width="200" />` : '—';
                  const darkImg = hasDark ? `<img src="${darkUrl}" width="200" />` : '—';
                  lines.push(`| **${s.desc}** | ${lightImg} | ${darkImg} |`);
                }
              }
            } else {
              lines.push('> No screenshots were captured for this run.');
            }

            lines.push(
              '',
              `**[Download full-resolution screenshots from workflow artifacts](${runUrl}#artifacts)**`,
            );

            core.setOutput('message', lines.join('\n'));

      - uses: marocchino/sticky-pull-request-comment@v2.9.4
        if: github.event_name == 'pull_request' && always()
        with:
          header: "App Screenshots"
          message: ${{ steps.set-screenshot-results.outputs.message }}
          hide_and_recreate: true
          hide_classify: "OUTDATED"
