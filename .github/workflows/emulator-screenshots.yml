name: Emulator Screenshots

on:
  pull_request:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

concurrency:
  group: screenshots-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  screenshots:
    name: Capture App Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Expo prebuild (generate android project)
        run: bunx expo prebuild --platform android --clean

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      - name: Run emulator and capture screenshots
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          emulator-boot-timeout: 300
          script: |
            # Build the debug APK (ANDROID_HOME is set by the emulator runner)
            ./android/gradlew -p android assembleDebug

            # Install the APK
            adb install android/app/build/outputs/apk/debug/app-debug.apk

            # Launch the app
            adb shell am start -n com.heywood8.monkeep.dev/.MainActivity

            # Create output directory
            mkdir -p screenshots

            # Wait for app to start and capture diagnostic info
            sleep 15
            echo "=== Device info ==="
            adb shell getprop ro.build.version.sdk
            echo "=== Running activities ==="
            adb shell dumpsys activity activities | grep -E "mResumedActivity|topResumedActivity" || true
            echo "=== Logcat (last 50 app lines) ==="
            adb logcat -d -t 50 --pid=$(adb shell pidof com.heywood8.monkeep.dev) 2>/dev/null || true
            echo "=== ADB screenshot before Maestro ==="
            adb shell screencap -p /sdcard/debug_before_maestro.png
            adb pull /sdcard/debug_before_maestro.png screenshots/debug_before_maestro.png || true

            # Run Maestro flow to navigate and take screenshots
            # Maestro uses extendedWaitUntil to poll for app readiness
            maestro test .maestro/take-screenshots.yaml || true

            # Capture Maestro debug artifacts
            cp -r ~/.maestro/tests/* screenshots/ 2>/dev/null || true

            # List captured screenshots
            ls -la screenshots/ || echo "No screenshots directory found"

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-screenshots
          path: screenshots/
          retention-days: 30
          if-no-files-found: warn

      - name: Post PR comment with screenshot link
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## App Screenshots',
              '',
              'Emulator screenshots of the main app screens have been captured for this PR.',
              '',
              '| Screen | Description |',
              '|--------|-------------|',
              '| `00_language_selection` | First-launch language picker |',
              '| `01_operations` | Operations tab (default view) |',
              '| `02_graphs` | Graphs tab |',
              '| `03_accounts` | Accounts tab |',
              '| `04_categories` | Categories tab |',
              '',
              `**[Download screenshots from workflow artifacts](${runUrl}#artifacts)**`,
            ].join('\n');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## App Screenshots';
            const existing = comments.find(c => c.body?.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
