name: Emulator Screenshots

on:
  pull_request:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: screenshots-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  screenshots:
    name: Capture App Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Expo prebuild (generate android project)
        env:
          APP_VARIANT: production
        run: bunx expo prebuild --platform android --clean

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      - name: Run emulator and capture screenshots
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -skin 1080x1920
          disable-animations: true
          emulator-boot-timeout: 300
          script: |
            # Build release APK for x86_64 only (matches emulator arch, skips unnecessary ABIs)
            APP_VARIANT=production ./android/gradlew -p android assembleRelease -PreactNativeArchitectures=x86_64

            # Install the APK
            adb install android/app/build/outputs/apk/release/app-release.apk

            # Launch the app
            adb shell am start -n com.heywood8.monkeep/.MainActivity

            # Create output directory
            mkdir -p screenshots

            # Run Maestro flow to navigate and take screenshots
            maestro test .maestro/take-screenshots.yaml || true

            # Capture Maestro debug artifacts on failure
            cp -r ~/.maestro/tests/* screenshots/ 2>/dev/null || true

            # List captured screenshots
            ls -la screenshots/ || echo "No screenshots directory found"

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-screenshots
          path: screenshots/
          retention-days: 30
          if-no-files-found: warn

      - name: Push screenshots to ci-screenshots branch
        if: github.event_name == 'pull_request' && always()
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCREENSHOT_DIR="pr-${PR_NUMBER}"
          BACKUP_DIR="/tmp/screenshots-backup"

          # Check if any screenshots exist
          if ! ls screenshots/*.png 1>/dev/null 2>&1; then
            echo "No screenshot files found, skipping upload"
            exit 0
          fi

          # Save screenshots outside the working tree (branch switches may clean it)
          mkdir -p "$BACKUP_DIR"
          cp screenshots/*.png "$BACKUP_DIR/"

          # Configure git for the push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or switch to the ci-screenshots orphan branch
          git fetch origin ci-screenshots 2>/dev/null || true
          if git rev-parse --verify origin/ci-screenshots >/dev/null 2>&1; then
            git checkout ci-screenshots
          else
            git checkout --orphan ci-screenshots
            git rm -rf . 2>/dev/null || true
            git clean -fd 2>/dev/null || true
            git commit --allow-empty -m "Initialize ci-screenshots branch"
          fi

          # Copy screenshots into a PR-specific directory
          mkdir -p "${SCREENSHOT_DIR}"
          cp "$BACKUP_DIR"/*.png "${SCREENSHOT_DIR}/"

          # Commit and push
          git add "${SCREENSHOT_DIR}"
          git commit -m "Update screenshots for PR #${PR_NUMBER}" || echo "No changes to commit"
          git push origin ci-screenshots

          # Switch back to the PR branch and restore screenshots
          git checkout - 2>/dev/null || true
          mkdir -p screenshots
          cp "$BACKUP_DIR"/*.png screenshots/

      - name: Build PR comment body
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        id: set-screenshot-results
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const rawBase = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/ci-screenshots/pr-${prNumber}`;

            const screens = [
              { file: '00_language_selection', desc: 'First-launch language picker' },
              { file: '01_operations', desc: 'Operations tab (default view)' },
              { file: '02_graphs', desc: 'Graphs tab' },
              { file: '03_accounts', desc: 'Accounts tab' },
              { file: '04_categories', desc: 'Categories tab' },
            ];

            // Check which screenshots actually exist
            const available = screens.filter(s =>
              fs.existsSync(`screenshots/${s.file}.png`)
            );

            const lines = [
              '## App Screenshots',
              '',
            ];

            if (available.length > 0) {
              // Build a table with embedded images
              lines.push(
                '| Screen | Screenshot |',
                '|--------|-----------|',
              );
              for (const s of available) {
                const imgUrl = `${rawBase}/${s.file}.png`;
                lines.push(`| **${s.desc}** | <img src="${imgUrl}" width="270" /> |`);
              }
            } else {
              lines.push('> No screenshots were captured for this run.');
            }

            lines.push(
              '',
              `**[Download full-resolution screenshots from workflow artifacts](${runUrl}#artifacts)**`,
            );

            core.setOutput('message', lines.join('\n'));

      - uses: marocchino/sticky-pull-request-comment@v2.9.4
        if: github.event_name == 'pull_request' && always()
        with:
          header: "App Screenshots"
          message: ${{ steps.set-screenshot-results.outputs.message }}
          hide_and_recreate: true
          hide_classify: "OUTDATED"
